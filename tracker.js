(()=>{"use strict";var t={d:(e,n)=>{for(var r in n)t.o(n,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}};t.d({},{a:()=>wt});var e={};t.r(e),t.d(e,{createDOMElement:()=>s,extend:()=>o,format:()=>h,formatTime:()=>d,getMobileOperatingSystem:()=>u,getUrlSearchParameter:()=>p,isTouchDevice:()=>g,merge:()=>c,path:()=>l,smallScreen:()=>m,toLatLng:()=>i,toPosition:()=>r,trackerMode:()=>f,update:()=>a});var n={};function r(t){return Array.isArray(t)?t:[t.lat,t.lng,t.alt]}function i(t){return"lat"in t?t:{lat:t[0],lng:t[1],alt:t[2]}}function a(t,...e){for(var n in e){var r=e[n];for(var i in r)i in t&&(t[i]=r[i])}return t}function o(t,...e){for(var n in e){var r=e[n];for(var i in r)i in t||(t[i]=r[i])}return t}function c(t,...e){for(var n in e){var r=e[n];for(var i in r)t[i]=r[i]}return t}function s(t,e,n){var r=document.createElement(t);return r.className=e||"",n&&n.appendChild(r),r}function l(t){if(window.location.pathname.endsWith("/src/"))return"../"+t}function h(t,...e){for(var n=0;n<e.length;n++)t=t.replaceAll("%"+(n+1)+"$",e[n].toString());return t}function d(t){if(t<1e3)return"0:00:00";var e=Math.floor(t/1e3),n=e%60,r=Math.floor(e/60)%60;return Math.floor(e/3600)+":"+(r<10?"0"+r:r)+":"+(n<10?"0"+n:n)}function u(){var t=navigator.userAgent||navigator.vendor||window.opera;return/windows phone/i.test(t)?"Windows Phone":/android/i.test(t)?"Android":/iPad|iPhone|iPod/.test(t)&&!window.MSStream?"iOS":null}function m(){return!(Math.min(screen.width,screen.height)>500)}function g(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0}function p(t,e=window.location.href){t=t.replace(/[\[\]]/g,"\\$&");var n=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)").exec(e);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null}function f(t){var e=p("mode");return new RegExp("(^|,)"+t+"(,|$)","i").test(e||"")}t.r(n),t.d(n,{bearing:()=>$,distance:()=>G,heading:()=>B,radialPoint:()=>J,toDegrees:()=>U,toRadians:()=>Z});var k={mode:"",websocket:"",watch:5,track:{deviation:7,minDistance:20,maxDistance:1e4},outdatingDelay:5,map:{defaultZoom:16,minZoom:4},lang:"en_US",update:function(t={}){a(this,t),w.set()},checkMode:function(t){return new RegExp("(^|,)"+t+"(,|$)","i").test(this.mode)}};k.mode=p("mode")||k.mode,k.websocket=p("websocket")||k.wsURL,k.lang=p("lang")||navigator.language||k.lang;var v=p("watch");v&&(k.watch=parseInt(v)),(v=p("track"))&&(v=v.split(":"),k.track.deviation=Number(v[0])||k.track.deviation,k.track.minDistance=Number(v[1])||k.track.minDistance,k.track.maxDistance=Number(v[2])||k.track.maxDistance);var w={lang:"en-US",msgLocWaiting:"Waiting for a location...",locationerror:["Geolocation error: no such service","Geolocation error: permission denied","Geolocation error: position unavailable","Geolocation error: timeout expired","Geolocation error: service unavilable"],error:[],msgWsOpen:"WebSocket is open: ",msgWsClosed:"WebSocket closed: ",errWebSocket:"WebSocket connection failed: ",actionShowAll:"Show all objects",actionSetCenter:"Center map to location",actionSearch:" Search",msgWildcards:"Search wildcards: ? *",msgFound:"Found: ",msgNotFound:"Nothing found...",msgTapToLocate:"Tap the name to locate",hdrSourceTable:["","Name","LAT,deg","LON,deg","ACC,m","HDG,deg","SPD,km/h","Timestamp"],hdrNodeInfo:"Track: %1$",tblNodeInfo:["Node","Time","Path,km","Speed,km/h","Heading,deg","Course,deg"],actionAbout:"About",set:function(){var t=k.lang.split("-")[0].split("_")[0];b[t]&&a(this,b[t])}},b=[],y={pane:null},T=[{img:"./images/btn_locate.png",title:w.actionSetCenter,onclick:function(){dt.setCenterToLocation()}},{img:"./images/btn_bound.png",title:w.actionShowAll,onclick:function(){dt.fitAllObjects()}}],M=s("div","tracker-button");for(var S of T){var N=s("div","tracker-button",M);N.addEventListener("click",S.onclick,!1);var x=s("img","tracker-button",N);x.src=S.img,x.title=S.title}var O=s("form","tracker-search",M);O.style.display="",O.onclick=function(){O.searchCriteria.focus(),O.searchCriteria.scrollIntoView(),R.info(w.msgWildcards,5)},O.onsubmit=function(t){var e=dt.searchObjectsByName(t.target.searchCriteria.value);return H.create(e,w.msgFound),!1};var A=s("input","tracker-search",O);A.type="text",A.name="searchCriteria",A.placeholder=w.actionSearch,A.autocomplete="off",y.pane=M;var E={pane:null,paneTitle:null,scrollArea:null},I=function(t,e="tracker-pane"){var n=s("div",e);n.hidden=!0,t.pane=n;var r=s("div","tracker-title",n);t.paneTitle=s("div","tracker-title-text",r);var i=s("img","tracker-title",r);i.src="./images/btn_close.png",i.onclick=function(e){t.pane.hidden=!0}};I(E),E.scrollArea=s("div","tracker-scroll",E.pane);var C,j=function(){var t=(window.innerHeight||document.documentElement.clientHeight)-145+"px",e=(window.innerWidth||document.documentElement.clientWidth)-25+"px";t===E.scrollArea.style.maxHeight&&e===E.scrollArea.style.maxWidth||(E.scrollArea.style.maxHeight=t,E.scrollArea.style.maxWidth=e)};j(),C=j,"orientation"in window.screen?screen.orientation.addEventListener("oncnange",C):screen.addEventListener("orientationchange",C),window.addEventListener("resize",C);var H={create:function(t,e){E.pane.hidden=!0;var n=t.length;if(0!==n){E.paneTitle.innerHTML=e+n,E.scrollArea.innerHTML="";var r=s("table","tracker-table",E.scrollArea);r.onclick=function(t){if("td"===t.target.tagName.toLowerCase()){var e=t.target.parentNode.lastChild.innerHTML;dt.locateObject(e),E.pane.hidden=!0}};var i=s("tr","",r);for(var a in w.hdrSourceTable)s("th","tracker-cell",i).innerHTML=w.hdrSourceTable[a];for(a=0;a<n;a++){var o=t[a],c=o.source,l=s("tr","tracker-table",r);s("td","tracker-cell-number",l).innerHTML=(o.tracked?"*":"")+(a+1),s("td","tracker-cell",l).innerHTML=c.name,s("td","tracker-cell-number",l).innerHTML=c.latitude.toFixed(6),s("td","tracker-cell-number",l).innerHTML=c.longitude.toFixed(6),s("td","tracker-cell-number",l).innerHTML=c.accuracy.toFixed(1),s("td","tracker-cell-number",l).innerHTML=c.heading.toFixed(1),s("td","tracker-cell-number",l).innerHTML=(3.6*c.speed).toFixed(0),s("td","tracker-cell",l).innerHTML=new Date(c.timestamp).toLocaleString(),s("td","tracker-invisible",l).innerHTML=c.id}E.pane.hidden=!1,R.info(w.msgTapToLocate)}else R.info(w.msgNotFound)}},D={pane:null,paneTitle:null,infoArea:null};I(D),D.infoArea=s("div","tracker-pane",D.pane);var P={create:function(t,e){D.pane.hidden=!0,D.paneTitle.innerHTML=e,D.infoArea.innerHTML="",D.pane.hidden=!1;var n=D.infoArea.getBoundingClientRect(),r=s("table","tracker-table",D.infoArea);r.style.maxWidth=Math.max(200,n.width)+"px",this.makeRow(r,w.tblNodeInfo[0],t.index+1),this.makeRow(r,w.tblNodeInfo[1],d(t.totalTime)),this.makeRow(r,w.tblNodeInfo[2],(t.path/1e3).toFixed(3)),this.makeRow(r,w.tblNodeInfo[3],(3.6*t.speed).toFixed(0)),this.makeRow(r,w.tblNodeInfo[4],t.heading?t.heading.toFixed(1):"-"),this.makeRow(r,w.tblNodeInfo[5],t.course?t.course.toFixed(1):"-"),D.pane.hidden=!1},makeRow:function(t,e,n){var r=s("tr","tracker-row",t);s("td","tracker-cell",r).innerHTML=e,s("td","tracker-cell-wide",r).innerHTML=n}},W={pane:s("div","tracker-console")};W.pane.hidden=!0;var R={log:function(t,e=3){console.log(t),this.update(t,e)},error:function(t,e=3){console.log(t);var n=t.code?w[t.type][t.code]:t.message;this.update(n,e)},info:function(t,e=3){this.update(t,e)},timer:null,pane:W.pane,update:function(t,e){this.cancel(),this.pane.innerHTML=t,this.pane.hidden=!1,this.timer=setTimeout((function(t){t.cancel()}),1e3*e,this)},cancel:function(){this.timer&&(clearTimeout(this.timer),this.timer=null,this.pane.hidden=!0)}};const F=Math.PI/180,_=6371e3;var Z=function(t){return t*F},U=function(t){return t/F};function G(t,e){var n=Object.values(t),r=Object.values(e),i=Z(n[0]),a=Z(r[0]),o=Z(r[0]-n[0]),c=Z(r[1]-n[1]),s=Math.sin(o/2)*Math.sin(o/2)+Math.cos(i)*Math.cos(a)*Math.sin(c/2)*Math.sin(c/2),l=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));return _*l}function B(t,e){return 360-$(t,e)}function $(t,e){var n=Object.values(t),r=Object.values(e),i=Z(n[0]),a=Z(n[1]),o=Z(r[0]),c=Z(r[1]),s=Math.atan2(Math.sin(a-c)*Math.cos(o),Math.cos(i)*Math.sin(o)-Math.sin(i)*Math.cos(o)*Math.cos(a-c))%(2*Math.PI);return(U(s)+360)%360}function J(t,e,n){var r=Object.values(t),i=n/_,a=Z(e%360),o=Z(r[0]),c=Z(r[1]),s=Math.asin(Math.sin(o)*Math.cos(i)+Math.cos(o)*Math.sin(i)*Math.cos(a)),l=c+Math.atan2(Math.sin(a)*Math.sin(i)*Math.cos(o),Math.cos(i)-Math.sin(o)*Math.sin(s));return r=[U(s),(U(l)+540)%360-180],Array.isArray(t)?r:{lat:r[0],lng:r[1]}}var V={websocket:null,error:null,start(t=k.websocket){if(t&&!this.websocket){var e=("https:"===window.location.protocol?"wss:":"ws:")+t.replace("ws:","").replace("wss:","");try{this.websocket=new WebSocket(e),this.websocket.onmessage=function(t){"string"==typeof t.data&&Y(t.data)},this.websocket.onopen=function(t){R.log(w.msgWsOpen+t.target.url)},this.websocket.onclose=z,this.websocket.onerror=q}catch(t){R.error(t)}}},send(t){this.websocket&&this.websocket.send(t)},stop(){this.websocket&&this.websocket.close()}},z=function(t){this.error||R.log(w.msgWsClosed+t.target.url),this.websocket=null,this.error=null}.bind(V),q=function(t){this.error=t,t.message=w.errWebSocket+t.target.url,R.error(t)}.bind(V),K={location:{},source:function(t){!function(t){try{if(!(t.id&&t.latitude.between(-90,90)&&t.longitude.between(-180,180)&&t.accuracy>0&&t.timestamp<=Date.now()))throw new Error;t.name=t.name||"unknown",t.timeout=t.timeout||k.watch}catch(e){throw new rt("Illegal value or property missing",1,t)}}(t);var e=nt[t.id];e&&t.timestamp<e.timestamp||dt.onSourceUpdate(new it(t))},message:function(t){R.log(t.message)}};function Q(t){V.send(t)}var X=function(t){let e=new Event("action");return e.trackerObj=t,e};function Y(t){var e=JSON.parse(t),n=e.action.split(":")[0];if(!(n in K))throw new rt("Unknown action",1,e);K[n](e),wt.dispatchEvent(new X(e))}function tt(t){let e=new Event("actionerror");return merge(e,t)}var et={toTracker:function(t){try{Y(t)}catch(t){console.error(t),wt.dispatchEvent(new tt(t)),this.fromTracker(toJSON({event:"error:"+t.type,message:t.message,code:t.code,object:t.trackerObj}))}},fromTracker:Q};Number.prototype.between=function(t,e){return this>=t&&this<=e};var nt=[];function rt(t,e=0,n){this.message=t,this.type="trackererror",this.code=e,this.stack=(new Error).stack,this.trackerObj=n}function it(t){this.id=location.host,this.name=location.host,this.iconid=0,this.latitude=void 0,this.longitude=void 0,this.accuracy=void 0,this.speed=void 0,this.heading=void 0,this.timestamp=Date.now(),this.timeout=k.outdatingDelay,this.getLatLng=function(){return{lat:this.latitude,lng:this.longitude,alt:0}},this.setLatLng=function(t){return this.latitude=t.lat,this.longitude=t.lng,this},this.getPosition=function(){return[this.latitude,this.longitude,0]},this.setPosition=function(t){return this.latitude=t[0],this.longitude=t[1],this},this.update=function(){return Y(JSON.stringify(c({action:"source:update"},this))),Q(JSON.stringify(c({event:"source:update"},this))),this},a(this,t)}function at(t){this.message=t,this.update=function(){Y(JSON.stringify(c({action:"message:update"},this))),Q(JSON.stringify(c({event:"message:update"},this)))}}function ot(t){this.id=t.id,this.name=t.name}function ct(t,e){this.id=t.id,this.source=t,this.tracked=e}rt.prototype=new Error;var st={interval:null,start(t=k.outdatingDelay){this.stop(),this.interval||(this.interval=setInterval((function(){for(var t in nt){var e=nt[t];"outdated"in e&&e.outdated()}}),1e3*t))},stop(){this.interval&&(clearInterval(this.interval),this.interval=null)}},lt=[new(L.Control.extend({options:{position:"bottomright"},onAdd:function(t){return W.pane}})),new(L.Control.extend({options:{position:"topright"},onAdd:function(t){return y.pane}})),new(L.Control.extend({options:{position:"bottomleft"},onAdd:function(t){var e=D.pane;return L.DomEvent.disableClickPropagation(e),L.DomEvent.disableScrollPropagation(e),e}})),new(L.Control.extend({options:{position:"topright"},onAdd:function(t){var e=E.pane;return L.DomEvent.disableClickPropagation(e),L.DomEvent.disableScrollPropagation(e),e}}))];function ht(t,e){this.map=t,this.layer=e,this.marker=null,this.name="",this.nodes=[],this.track=L.polyline([],{weight:2,color:"blue"}),this.rubberThread=L.polyline([],{weight:2,color:"red"}),this.lastLatLng=null,this.lastHeading=0,this.isMarkerTracked=function(t){return t===this.marker},this.isTracked=function(){return this.marker},this.start=function(t){this.remove();var e=t.getLatLng();this.rubberThread.setLatLngs([e,e]).addTo(this.layer),this.track.addTo(this.layer),this.name=t.source.name,this.lastLatLng=e,this.lastHeading=t.source.heading||0,this.nodes=[],this.addTrackNode(t.source,0).fire("click"),this.marker=t,this.marker.on("move",this.onMarkerMove)},this.onMarkerMove=function(t){if(this.isMarkerTracked(t.sourceTarget)){this.marker.openTooltip();var e=t.latlng;this.rubberThread.setLatLngs([this.lastLatLng,e]);var n=G(this.lastLatLng,e),r=Math.max(k.track.minDistance,this.marker.source.accuracy),i=B(this.lastLatLng,e);if(n>r&&Math.abs(this.lastHeading-i)>k.track.deviation||n>k.track.maxDistance)this.lastHeading=i,this.addTrackNode(this.marker.source,n).fire("click");else{var a=this.getNodeEntry(this.nodes.length-1);a.course=i,P.create(a,h(w.hdrNodeInfo,this.name))}this.map.setView(e,this.map.getZoom())}}.bind(this),this.addTrackNode=function(t,e){this.lastLatLng=t.getLatLng(),this.track.addLatLng(this.lastLatLng);var n=L.circle(this.lastLatLng,t.accuracy,{weight:1,color:"blue"}).addTo(this.layer);return n.info=this.TrackNodeInfo(this.nodes.length,t.timestamp,e),n.on("click",this.onNodeClick),this.nodes.push(n),n},this.TrackNodeInfo=function(t,e,n){return{i:t,timestamp:e,distance:n,path:0===t?0:this.nodes[t-1].info.path+n}},this.onNodeClick=function(t){var e=t.sourceTarget,n=this.getNodeEntry(e.info.i);P.create(n,h(w.hdrNodeInfo,this.name))}.bind(this),this.getNodeEntry=function(t){return{index:t,totalTime:this.nodes[t].info.timestamp-this.nodes[0].info.timestamp,path:this.nodes[t].info.path,speed:0===t?null:this.nodes[t].info.distance/((this.nodes[t].info.timestamp-this.nodes[t-1].info.timestamp)/1e3),heading:0===t?null:B(this.nodes[t-1].getLatLng(),this.nodes[t].getLatLng()),course:t===this.nodes.length-1?null:B(this.nodes[t].getLatLng(),this.nodes[t+1].getLatLng())}},this.stop=function(){this.marker.off("move",this.onMarkerMove),this.rubberThread.setLatLngs([]),this.marker=null},this.remove=function(){this.track.setLatLngs([]),this.layer.clearLayers()}}var dt={},ut=function(){return o(new Event("ready"),{map:dt})};String.prototype.replaceAll=function(t,e){return this.split(t).join(e)},ot.prototype.outdated=function(){var t=this.marker.source;t.timestamp+1e3*t.timeout<Date.now()&&this.marker.setOpacity(.4)},ot.prototype.remove=function(){};var mt={setCenterToLocation:function(t=k.watch){R.info(w.msgLocWaiting,t),this.locate({setView:!0,watch:!1,timeout:1e3*t}).on("locationfound",(function(t){R.cancel(),this.setZoom(k.map.defaultZoom)})).on("locationerror",(function(t){R.error(t)}))},searchObjectsByName:function(t){t="^"+t.replaceAll("?",".{1}").replaceAll("*",".*")+"$";var e=[];try{var n=new RegExp(t,"i")}catch(t){return R.error(t),e}for(var r in nt)if(n.test(nt[r].name)){var i=nt[r];e.push(new ct(i.marker.source,this.tracking.marker===i.marker))}return e},locateObject:function(t){var e=nt[t].marker,n=this.tracking.marker||e;e===n?this.setView(e.getLatLng(),k.map.defaultZoom):(this.fitAllObjects(),n.openTooltip()),e.openTooltip(),this.tracking.isMarkerTracked(e)||setTimeout((function(t){t.closeTooltip()}),5e3,e)},fitAllObjects:function(){if(this.hasLayer(this.trackerObjectLayer)){var t=this.trackerObjectLayer.getBounds().extend(this.tracking.track.getBounds());t.isValid()&&this.fitBounds(t)}},trackerIcons:[],getTrackerIcon:function(t=2){return t=Math.max(0,Math.min(t,this.trackerIcons.length-1)),this.trackerIcons[t]},makeTrackerIcon:function(t,e){return e=e||32,L.icon({iconSize:[e,e],iconAnchor:[e/2,e],iconUrl:t})},tracking:null,onSourceUpdate:function(t){var e=this.getTrackerIcon(t.iconid),n=nt[t.id],r=t.getLatLng();if(n)n.accuracyCircle.setLatLng(r),n.accuracyCircle.setRadius(Math.min(t.accuracy,1500)),n.marker.source=t,n.marker.setLatLng(r);else{(n=new ot(t)).objectMap=this,n.marker=L.marker(r).bindTooltip(n.name,{className:"tracker-tooltip"}).addTo(this.trackerObjectLayer),n.marker.source=t;var i=function(t){this.tracking.marker?this.tracking.marker===t.target&&this.tracking.stop():this.tracking.start(t.target)}.bind(this);n.marker.on("click",i),n.accuracyCircle=L.circle(r,Math.min(t.accuracy,1500),{weight:1,color:"blue"}).addTo(this.trackerObjectLayer),nt[t.id]=n}return n.marker.setIcon(e),n.marker.setOpacity(1),n}},gt={source:new it({accuracy:1e6,iconid:4}),interval:null,start(t=k.watch){this.stop(),dt.locate({watch:!0,timeout:1e3*t}).on("locationfound",pt).on("locationerror",ft),dt.locate({watch:!0,timeout:1e3*t,enableHighAccuracy:!0}).on("locationfound",pt),this.interval=setInterval((function(t){t.source.latitude&&t.source.update(),t.source.accuracy=1e6}),1e3*t,this)},stop(){this.interval&&(clearInterval(this.interval),this.interval=null,dt.stopLocate())}},pt=function(t){t.timestamp>=this.source.timestamp&&t.accuracy<this.source.accuracy&&(this.source.setLatLng(t.latlng),a(this.source,t))}.bind(gt),ft=function(t){R.error(t)}.bind(gt),kt=[];function vt(t){for(var e in kt){var n=kt[e];"object"==typeof n&&"stop"in n&&n.stop()}dt.remove()}var wt=new function(t={}){var e=new EventTarget;return e.on=function(t,e){this.addEventListener(t,e)},e.once=function(t,e){this.addEventListener(t,e,{once:!0})},e.off=function(t,e){this.removeEventListener(t,e)},o(e,t)}({version:"0.3",load:function(t="map",e={}){!function(t,e={}){k.update(e),function(t="map"){(dt=L.map(t,{center:[51.477928,-.001545],zoom:k.map.defaultZoom,minZoom:k.map.minZoom,zoomControl:!1})).locate({setView:!0,timeout:1500}).once("locationfound",(function(t){wt.dispatchEvent(new ut),dt.setZoom(k.map.defaultZoom)})).once("locationerror",(function(t){R.error(t),wt.dispatchEvent(new ut)})),L.tileLayer(window.location.protocol+"//{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(dt),document.getElementsByClassName("leaflet-control-attribution")[0].onclick=function(t){t.preventDefault()},o(dt,mt),dt.trackerIcons=[dt.makeTrackerIcon("./images/phone_0.png"),dt.makeTrackerIcon("./images/phone_b.png"),dt.makeTrackerIcon("./images/phone_g.png"),dt.makeTrackerIcon("./images/phone_r.png"),dt.makeTrackerIcon("./images/phone_y.png")],dt.trackerObjectLayer=L.featureGroup().addTo(dt),dt.trackLayer=L.layerGroup().addTo(dt),dt.tracking=new ht(dt,dt.trackLayer),function(t){for(var e in lt)lt[e].addTo(t)}(dt)}(t);var n=new NoSleep;n.stop=n.disable,kt=[st,gt,V,n],window.addEventListener("unload",vt),k.checkMode("watch")&&gt.start(),k.websocket&&V.start(),st.start(),u()&&n.enable()}(t,e)},SourceLocation:function(t){return new it(t)},Message:function(t){return new at(t)},whenReady:function(t){"whenReady"in dt?dt.whenReady(t,{map:dt}):this.once("ready",t)},getMap:function(){return dt},geoUtil:n,util:e,webview:et});window.tracker=wt})();